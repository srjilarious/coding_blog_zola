
<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://www.walknsqualk.com/js/theme.min.js" integrity="sha384-pb++s6uBRKaQv+iAXpgA/H3IlpLZdO14tTwuCI7uXmz4aaZdByoCcM+6BhynMq/1"></script>
  <link rel="stylesheet" href="https://www.walknsqualk.com/abridge.css?h=f3cf078b0dda0efcc1e1" />
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="base" content="https://www.walknsqualk.com/" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#333333" />
  <meta name="msapplication-TileColor" content="#333333" />
  <link rel="manifest" href="https://www.walknsqualk.com/manifest.min.json" />
  <link rel="mask-icon" href="https://www.walknsqualk.com/safari-pinned-tab.svg" color="#ff9900" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://www.walknsqualk.com/apple-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://www.walknsqualk.com/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="https://www.walknsqualk.com/favicon-16x16.png" />
  <link rel="alternate" type="application/atom+xml" title="Walk N&#x27; Squawk Atom Feed" href="https://www.walknsqualk.com/atom.xml" />
  <meta name="robots" content="index, follow" />
  <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <title>FPGA Design for Software Engineers, Part 3 - Seven Segment Displays | Walk N' Squawk</title>
  <meta name="author" content="Jeff DeWall" />
  <meta name="copyright" content="Walk N&#x27; Squawk" />
  <meta name="description" content="A Zig and Elixir Coding Blog, with some FPGA and Japanese content as well." />
  <link rel="canonical" href="https://www.walknsqualk.com/016-fpga-start3/" />
  <meta name="keywords" content="Zig, Rust, Elixir, Python, Japanese, German, Coding" />
  <meta name="google-site-verification" content="Your Google Site verification code." />
  <meta name="msvalidate.01" content="Your Bing Site verification code." />
  <meta property="og:url" content="https://www.walknsqualk.com/016-fpga-start3/" />
  <meta name="twitter:url" content="https://www.walknsqualk.com/016-fpga-start3/" />
  <meta property="og:description" content="A Zig and Elixir Coding Blog, with some FPGA and Japanese content as well." />
  <meta name="twitter:description" content="A Zig and Elixir Coding Blog, with some FPGA and Japanese content as well." />
  <meta property="og:title" content="FPGA Design for Software Engineers, Part 3 - Seven Segment Displays | Walk N&#x27; Squawk" />
  <meta name="twitter:title" content="FPGA Design for Software Engineers, Part 3 - Seven Segment Displays | Walk N&#x27; Squawk" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://www.walknsqualk.com/banner.png" />
  <meta property="og:image" content="https://www.walknsqualk.com/banner.png" />
  <meta property="og:site_name" content="Walk N&#x27; Squawk" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:type" content="website" />
  <meta property="og:updated_time" content="2020-04-20" />
  <meta name="twitter:site" content="@your-user-name" />
  <meta name="twitter:creator" content="@your-user-name" />
  <script defer src="https://www.walknsqualk.com/js/abridge.min.js?h=e0f9a881a665c86cce9c" integrity="sha384-QF67y7RnPkuDrJNQqn3/7nYxqxWkW/qHI7zN0WTES1aXbf+TotoByRBb835fUE6U"></script>
  <noscript><link rel="stylesheet" href="https://www.walknsqualk.com/nojs.css" /></noscript>
</head>
<body>
  <header>
    <nav>
      <div><big><a href="https://www.walknsqualk.com" title="Walk N&#x27; Squawk"><img src="https://www.walknsqualk.com//logo.png" alt="WalkNSqualk" width="48" height="48" /> Walk N' Squalk</a></big></div>
      <div>

        <div>
          <ul><li><a class="s110" href="https://www.walknsqualk.com/archive/"> Posts </a></li><li><a class="s110" href="https://www.walknsqualk.com/tags/"> Tags </a></li><li><i type="reset" id="mode" class="js svgs adjust"></i></ul>
        </div>

        <div>
          <div>
            <form autocomplete=off class="js" name="goSearch" id="searchbox">
              <div class="searchd">
                <input id="searchinput" type="text" placeholder="Search" title="Search" />
                <button type="submit" title="Search" class="svgs svgm search"></button>
              </div>
              <div class="results"><div id="suggestions"></div></div>
            </form>
          </div>
        </div>

      </div>
    </nav>
    <hr />
  </header>
  <main>
    <article>
      <h1><a href="https://www.walknsqualk.com/016-fpga-start3/">FPGA Design for Software Engineers, Part 3 - Seven Segment Displays</a></h1>

      <span class="s95"> Jeff DeWall <span class="rpad"></span> 17 min read <span class="rpad"></span> April 20, 2020 <span class="rpad"></span> #<a href="https://www.walknsqualk.com/tags/fpga/">FPGA</a>  #<a href="https://www.walknsqualk.com/tags/verilog/">Verilog</a> </span>

    


<p><a href="https://www.walknsqualk.com/015-fpga-start2/">Last time</a> we took a break from Verilog and hardware design to improve our build system.  This time we're back to Verilog and for our next FPGA project we'll create a seven segment driver circuit that will allow us to output hex characters to a single display.</p>
<p>A seven segment display is a set of LEDs arranged like an eight plus a decimal point like you see on cheap alarm clocks and the like.</p>
<span id="continue-reading"></span> <img src="labelled-seven-segment-display-standard.png" alt="A typical seven segment display" width="180" height="300" loading="lazy" />
<h3 id="article-series">Article Series</h3>
<ol>
<li><a href="https://www.walknsqualk.com/014-fpga-start/">Verilog and State Machines</a></li>
<li><a href="https://www.walknsqualk.com/015-fpga-start2/">Simulation and Build Tools</a></li>
<li>Seven Segment Displays</li>
<li><a href="https://www.walknsqualk.com/018-fpga-docker-build/">Docker Builds</a></li>
<li><a href="https://www.walknsqualk.com/019-fpga-build-updates/">Build System Updates, ECP5 Support</a></li>
<li><a href="https://www.walknsqualk.com/022-shift-reg-multiplex/">Time-Multiplexed Seven Segment Displays</a></li>
</ol>
<h2 id="updates-feb-23-2021">Updates Feb 23, 2021</h2>
<p>As mentioned at the end of <a href="https://www.walknsqualk.com/018-fpga-docker-build/">this article</a>, I've moved the main repository over to GitHub, so the article has been updated with links to that repo.</p>
<h1 id="our-first-pass">Our first pass</h1>
<p>First we'll build up a decoder module that takes a hexadecimal digit and outputs a byte to turn on the correct segments.  In the first example, we'll simply put all 8 LED values onto FPGA output pins.  Later we'll look at decreasing the number of physical pins we need using shift registers.</p>
<p>There are many tutorials online discussing the basics on seven segment displays which are very good.  For instance, the <a rel="noopener" target="_blank" href="https://www.jameco.com/Jameco/workshop/TechTip/working-with-seven-segment-displays.html">tutorial on Jameco</a>, where I tend to grab many electronics components from, is quite good.</p>
<p>One thing to keep in mind when laying out your circuit is whether you have common anode or common cathode seven segment displays.  You have common anode if you hook the shared pin of the display to Vcc and common cathode if you hook it to GND.  In my case I have common cathode segments, so all of the schematics are assuming you're using the same.</p>
<h2 id="building-a-seven-segment-display-encoder-in-verilog">Building a seven segment display encoder in Verilog</h2>
<p>The main idea is that we take in 4 bits as a single hex digit and output the 8 values for each of the segments, and the decimal point, that we want to light up on the seven segment display.  If we assign a bit to each of the segments and decimal point, we can then come up with our mapping.  First lets look at the pinout of the seven segment displays I'm using:</p>
 <img src="labelled_seven_segment_display_a_filled_pinout.png" alt="A typical seven segment display" width="180" height="300" loading="lazy" />
<p>The <code>CC</code> pin here on the top and bottom are the common cathode, and will be hooked to ground.</p>
<p>You can choose whatever mapping you want, but in my case, I chose to have the decimal point in the most significant bit (MSB) and starting with <code>a</code> on the top left, going around clockwise for the lower bits.  The one weird thing is that this swaps the <code>f</code> and <code>g</code> segments, at least as named, in the mapping but it made more sense to me to follow a clock-wise pattern in this case.</p>
<p>Given the pinout above, we'll start with bit 0 as <code>a</code> at the top to the right of the common pin and move clockwise around the device, but skipping the decimal point until the end.  That gives us a mapping where we assign for the eight output bits as <code>dp f g e d c b a</code></p>
<p>For example, with the above image we have the letter <code>a</code> lit up.  To achieve that we light up all of the segments except <code>d</code> at the bottom and the decimal point.  That gives us a binary value of: <code>0 1 1 1 0 1 1 1</code> which converted to hex is <code>0x77</code>.</p>
<p>In Verilog, our module just needs a case statement to setup the mapping as a <em>combinational</em> circuit:</p>
<pre data-lang="verilog" class="language-verilog z-code"><code class="language-verilog" data-lang="verilog"><span class="z-source z-systemverilog"><span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> A 4bit (single hex digit) to 7segment display decoder.
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog"><span class="z-keyword z-control z-systemverilog">module</span> <span class="z-entity z-name z-type z-module z-systemverilog">hex_to_7seg</span>
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    (
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">        i_val
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">        , o_seg_vals
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    );</span>
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog"><span class="z-support z-type z-systemverilog">    input</span> [<span class="z-constant z-numeric z-decimal z-systemverilog">3</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span><span class="z-constant z-numeric z-decimal z-systemverilog">0</span>] i_val;
</span><span class="z-source z-systemverilog"><span class="z-support z-type z-systemverilog">    output</span><span class="z-storage z-type z-systemverilog"> reg</span>[<span class="z-constant z-numeric z-decimal z-systemverilog">7</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span><span class="z-constant z-numeric z-decimal z-systemverilog">0</span>] o_seg_vals;
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog">    <span class="z-keyword z-control z-systemverilog">always</span> <span class="z-keyword z-operator z-other z-systemverilog">@</span>(<span class="z-keyword z-operator z-arithmetic z-systemverilog">*</span>) 
</span><span class="z-source z-systemverilog">    <span class="z-keyword z-control z-systemverilog">begin</span>
</span><span class="z-source z-systemverilog">        <span class="z-keyword z-control z-systemverilog">case</span>(i_val) 
</span><span class="z-source z-systemverilog">            <span class="z-constant z-numeric z-systemverilog">&#39;h0</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span> o_seg_vals <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-systemverilog">&#39;h5f</span>;
</span><span class="z-source z-systemverilog">            <span class="z-constant z-numeric z-systemverilog">&#39;h1</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span> o_seg_vals <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-systemverilog">&#39;h06</span>;
</span><span class="z-source z-systemverilog">            <span class="z-constant z-numeric z-systemverilog">&#39;h2</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span> o_seg_vals <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-systemverilog">&#39;h3b</span>;
</span><span class="z-source z-systemverilog">            <span class="z-constant z-numeric z-systemverilog">&#39;h3</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span> o_seg_vals <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-systemverilog">&#39;h2f</span>;
</span><span class="z-source z-systemverilog">            <span class="z-constant z-numeric z-systemverilog">&#39;h4</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span> o_seg_vals <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-systemverilog">&#39;h66</span>;
</span><span class="z-source z-systemverilog">            <span class="z-constant z-numeric z-systemverilog">&#39;h5</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span> o_seg_vals <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-systemverilog">&#39;h6d</span>;
</span><span class="z-source z-systemverilog">            <span class="z-constant z-numeric z-systemverilog">&#39;h6</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span> o_seg_vals <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-systemverilog">&#39;h7d</span>;
</span><span class="z-source z-systemverilog">            <span class="z-constant z-numeric z-systemverilog">&#39;h7</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span> o_seg_vals <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-systemverilog">&#39;h07</span>;
</span><span class="z-source z-systemverilog">            <span class="z-constant z-numeric z-systemverilog">&#39;h8</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span> o_seg_vals <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-systemverilog">&#39;h7f</span>;
</span><span class="z-source z-systemverilog">            <span class="z-constant z-numeric z-systemverilog">&#39;h9</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span> o_seg_vals <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-systemverilog">&#39;h6f</span>;
</span><span class="z-source z-systemverilog">            <span class="z-constant z-numeric z-systemverilog">&#39;ha</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span> o_seg_vals <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-systemverilog">&#39;h77</span>;
</span><span class="z-source z-systemverilog">            <span class="z-constant z-numeric z-systemverilog">&#39;hb</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span> o_seg_vals <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-systemverilog">&#39;h7c</span>;
</span><span class="z-source z-systemverilog">            <span class="z-constant z-numeric z-systemverilog">&#39;hc</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span> o_seg_vals <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-systemverilog">&#39;h59</span>;
</span><span class="z-source z-systemverilog">            <span class="z-constant z-numeric z-systemverilog">&#39;hd</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span> o_seg_vals <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-systemverilog">&#39;h3e</span>;
</span><span class="z-source z-systemverilog">            <span class="z-constant z-numeric z-systemverilog">&#39;he</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span> o_seg_vals <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-systemverilog">&#39;h79</span>;
</span><span class="z-source z-systemverilog">            <span class="z-constant z-numeric z-systemverilog">&#39;hf</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span> o_seg_vals <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-systemverilog">&#39;h71</span>;
</span><span class="z-source z-systemverilog">            <span class="z-keyword z-control z-systemverilog">default</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span> o_seg_vals <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-systemverilog">&#39;h00</span>;
</span><span class="z-source z-systemverilog">        <span class="z-keyword z-control z-systemverilog">endcase</span>
</span><span class="z-source z-systemverilog">    <span class="z-keyword z-other z-block z-systemverilog">end</span>
</span><span class="z-source z-systemverilog"><span class="z-meta z-object z-end z-systemverilog"><span class="z-keyword z-control z-systemverilog">endmodule</span></span>
</span></code></pre>
<p>You can follow along with the code in the <a rel="noopener" target="_blank" href="https://github.com/srjilarious/fpga_start/tree/post_3/">repository</a> branch for this article.</p>
<p>The module itself lives in <code>hex_to_7seg.v</code> in the <code>lib/</code> folder, which is where I'm placing any modules that we'll reuse across projects.  Our CMake script we discussed last time also assumes this is where extra modules live.</p>
<p>We use a <code>*</code> for the sensitivity list, so that any time <code>i_val</code> changes the outputs should be updated.  That is, this is like the half-adder we made in the first article and is <em>combinational</em>, i.e. doesn't have any state of its own; the output only depends on the current input.</p>
<p>The case statement maps all of the values on the 4-bit input to the segments as we outlined above.  We use the hexadecimal constant notation on the case labels and the segment values, <code>'h&lt;X&gt;</code>, although we could have just as easily used decimal or the binary <code>'b&lt;WXYZ&gt;</code> binary notation.</p>
<h2 id="connecting-our-counter-to-the-display">Connecting our Counter to the Display</h2>
<p>For this first test of the seven segment decoder, we'll output all of the segment values as individual pins, using 8 output pins <code>PIN1</code>-<code>PIN8</code> to drive our display.  You can find the code in the <code>02_seven_seg_parallel/</code> folder.</p>
<p>We create the <code>top</code> module (in <code>top.v</code>) to have the following port list:</p>
<pre data-lang="verilog" class="language-verilog z-code"><code class="language-verilog" data-lang="verilog"><span class="z-source z-systemverilog"><span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> look in pins.pcf for all the pin names on the TinyFPGA BX board
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog"><span class="z-keyword z-control z-systemverilog">module</span> <span class="z-entity z-name z-type z-module z-systemverilog">top</span> (
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog"><span class="z-support z-type z-systemverilog">    input</span> <span class="z-constant z-other z-net z-systemverilog">CLK</span>       <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> 16MHz clock
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    ,<span class="z-support z-type z-systemverilog"> output</span> <span class="z-constant z-other z-net z-systemverilog">LED</span>    <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> User/boot LED next to power LED
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    ,<span class="z-support z-type z-systemverilog"> output</span> <span class="z-constant z-other z-net z-systemverilog">USBPU</span>  <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> USB pull-up resistor
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    ,<span class="z-support z-type z-systemverilog"> output</span> <span class="z-constant z-other z-net z-systemverilog">PIN_1</span>  <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> 7-seg &#39;a&#39;
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    ,<span class="z-support z-type z-systemverilog"> output</span> <span class="z-constant z-other z-net z-systemverilog">PIN_2</span>  <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> 7-seg &#39;b&#39;
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    ,<span class="z-support z-type z-systemverilog"> output</span> <span class="z-constant z-other z-net z-systemverilog">PIN_3</span>  <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> 7-seg &#39;c&#39;
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    ,<span class="z-support z-type z-systemverilog"> output</span> <span class="z-constant z-other z-net z-systemverilog">PIN_4</span>  <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> 7-seg &#39;d&#39;
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    ,<span class="z-support z-type z-systemverilog"> output</span> <span class="z-constant z-other z-net z-systemverilog">PIN_5</span>  <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> 7-seg &#39;e&#39;
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    ,<span class="z-support z-type z-systemverilog"> output</span> <span class="z-constant z-other z-net z-systemverilog">PIN_6</span>  <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> 7-seg &#39;g&#39;
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    ,<span class="z-support z-type z-systemverilog"> output</span> <span class="z-constant z-other z-net z-systemverilog">PIN_7</span>  <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> 7-seg &#39;f&#39;
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    ,<span class="z-support z-type z-systemverilog"> output</span> <span class="z-constant z-other z-net z-systemverilog">PIN_8</span>  <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> 7-seg &#39;dp&#39;
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">);</span>
</span></code></pre>
<p>We use a counter like in the previous examples, using a few bits as the input to our decoder.  We define some constants for which bit is the low bit and which is the high bit, which we change depending on if we build for simulation or for synthesis on the real board, similar to how we did in the <code>state_machine</code> example.</p>
<p>We also declare an instance of our decoder module, hooking the counter in as the input and tying the output to a set of wires declared in our <code>top</code> module.</p>
<pre data-lang="verilog" class="language-verilog z-code"><code class="language-verilog" data-lang="verilog"><span class="z-source z-systemverilog"><span class="z-storage z-type z-net z-systemverilog">wire</span> [<span class="z-constant z-numeric z-decimal z-systemverilog">7</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span><span class="z-constant z-numeric z-decimal z-systemverilog">0</span>] seg_out;
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog"><span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> Used later to avoid a warning.
</span></span><span class="z-source z-systemverilog"><span class="z-storage z-type z-net z-systemverilog">wire</span> _seg_unused; 
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog"><span class="z-meta z-module z-inst z-systemverilog"><span class="z-storage z-type z-module z-systemverilog">hex_to_7seg</span> <span class="z-entity z-name z-type z-module z-systemverilog">segDisplay</span>(
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-inst z-systemverilog">        .<span class="z-support z-function z-port z-systemverilog">i_val</span>(counter[<span class="z-constant z-other z-net z-systemverilog">HIGH_BIT</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span><span class="z-constant z-other z-net z-systemverilog">LOW_BIT</span>]), 
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-inst z-systemverilog">        .<span class="z-support z-function z-port z-systemverilog">o_seg_vals</span>(seg_out)
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-inst z-systemverilog">    );</span>
</span></code></pre>
<p>Here we are instantiating the <code>hex_to_7seg</code> module that we defined above, giving it a name (which we don't care about here) of <code>segDisplay</code>.  We provide the input and output connections to the module using named arguments: the <code>.i_val(XYZ)</code> syntax.  Notice <code>i_val</code> and <code>o_seg_vals</code> are the parameter names of the ports in the <code>hex_to_7seg</code> module definition above.</p>
<p>We could also use positional arguments, but since Verilog supports named parameters, we might as well use them to keep things easier to maintain in the future.  By using named parameters, even if we rearrange the order of the arguments in the module definition, we'll match things up properly.</p>
<p>The last major piece in the <code>top</code> module is to take the output from our decoder and assign it to our output pins:</p>
<pre data-lang="verilog" class="language-verilog z-code"><code class="language-verilog" data-lang="verilog"><span class="z-source z-systemverilog"><span class="z-keyword z-control z-systemverilog">assign</span> <span class="z-keyword z-operator z-other z-systemverilog">{</span><span class="z-constant z-other z-net z-systemverilog">PIN_7</span>, <span class="z-constant z-other z-net z-systemverilog">PIN_6</span>, <span class="z-constant z-other z-net z-systemverilog">PIN_5</span>, <span class="z-constant z-other z-net z-systemverilog">PIN_4</span>, <span class="z-constant z-other z-net z-systemverilog">PIN_3</span>, <span class="z-constant z-other z-net z-systemverilog">PIN_2</span>, <span class="z-constant z-other z-net z-systemverilog">PIN_1</span><span class="z-keyword z-operator z-other z-systemverilog">}</span> <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> seg_out[<span class="z-constant z-numeric z-decimal z-systemverilog">6</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span><span class="z-constant z-numeric z-decimal z-systemverilog">0</span>];
</span><span class="z-source z-systemverilog"><span class="z-keyword z-control z-systemverilog">assign</span> _seg_unused <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> seg_out[<span class="z-constant z-numeric z-decimal z-systemverilog">7</span>];
</span><span class="z-source z-systemverilog"><span class="z-keyword z-control z-systemverilog">assign</span> <span class="z-constant z-other z-net z-systemverilog">PIN_8</span> <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> counter[<span class="z-constant z-other z-net z-systemverilog">LED_BLINK_BIT</span>];
</span></code></pre>
<p>Since we are not outputting a value that ever turns the decimal point on from our decoder, we don't use the MSB value from the <code>seg_out</code> wires and instead assign it to an unused wire to avoid a warning.</p>
<p>We instead assign the value of the counter's LED blinking bit to our decimal point so that it will blink on and off as we count up.</p>
<h2 id="adding-a-mock-seven-segment-display-to-our-test-bench">Adding a mock seven segment display to our test bench</h2>
<p>Now on the simulation side, we need to have a class that takes in the output from our circuit and lights up mock LED segments so we can see if everything works as we expect.  We could of course just create a waveform to check things like with the <code>state_machine</code> but since we have a fancy SFML setup already, let's make a graphical example.</p>
<p>If you look in the repo's <code>assets/</code> folder, you'll see some amazing programmer art of horizontal, vertical and decimal point LED segments for both on and off states.  We'll load these textures and use them in 8 individual SFML sprites that we'll manually place into a decent location to mimic a real seven segment display.</p>
<p>You can see the mock seven segment display code in the <code>support/SevenSegDisplay.h</code> header and its corresponding <code>support/SevenSegDisplay.cpp</code> source file.</p>
<p>The code here is pretty simple, we provide a reference to a struct of textures to use for the various segment states and the segment display class provides an interface for setting the state of each segment and drawing it to the screen.</p>
<p>In the main simulation file we load up our textures and create our mock seven segment display with the following code:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++">SevenSegDisplayTextures textures<span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">textures<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-variable z-other z-readwrite z-member z-c++">horzOff</span><span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">loadFromFile</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>assets/horz_segment_off.png<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">textures<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-variable z-other z-readwrite z-member z-c++">horzOn</span><span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">loadFromFile</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>assets/horz_segment_on.png<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">textures<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-variable z-other z-readwrite z-member z-c++">vertOff</span><span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">loadFromFile</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>assets/vert_segment_off.png<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">textures<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-variable z-other z-readwrite z-member z-c++">vertOn</span><span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">loadFromFile</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>assets/vert_segment_on.png<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">textures<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-variable z-other z-readwrite z-member z-c++">decimalOff</span><span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">loadFromFile</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>assets/dp_segment_off.png<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">textures<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-variable z-other z-readwrite z-member z-c++">decimalOn</span><span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">loadFromFile</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>assets/dp_segment_on.png<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++">SevenSegDisplay <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">seg</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-variable z-parameter z-c++">textures</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">seg<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-variable z-other z-readwrite z-member z-c++">position</span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c++">sf<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">Vector2f</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-constant z-numeric z-float z-decimal z-c++">100<span class="z-punctuation z-separator z-decimal z-c++">.</span>0<span class="z-storage z-type z-numeric z-c++">f</span></span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-float z-decimal z-c++">100<span class="z-punctuation z-separator z-decimal z-c++">.</span>0<span class="z-storage z-type z-numeric z-c++">f</span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>then in our simulation loop, after running the circuit however many number of ticks per frame we want, we clear the screen, update each segment's current state from our output pins, and then draw the result to the screen.</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Clear screen
</span></span><span class="z-source z-c++">renderWin<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">clear</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++">seg<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">setSegment</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">Segment<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>A<span class="z-punctuation z-separator z-c++">,</span> tb<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-variable z-other z-readwrite z-member z-c++">m_core</span><span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-variable z-other z-readwrite z-member z-c++">PIN_1</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">seg<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">setSegment</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">Segment<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>B<span class="z-punctuation z-separator z-c++">,</span> tb<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-variable z-other z-readwrite z-member z-c++">m_core</span><span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-variable z-other z-readwrite z-member z-c++">PIN_2</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">seg<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">setSegment</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">Segment<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>C<span class="z-punctuation z-separator z-c++">,</span> tb<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-variable z-other z-readwrite z-member z-c++">m_core</span><span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-variable z-other z-readwrite z-member z-c++">PIN_3</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">seg<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">setSegment</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">Segment<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>D<span class="z-punctuation z-separator z-c++">,</span> tb<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-variable z-other z-readwrite z-member z-c++">m_core</span><span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-variable z-other z-readwrite z-member z-c++">PIN_4</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">seg<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">setSegment</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">Segment<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>E<span class="z-punctuation z-separator z-c++">,</span> tb<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-variable z-other z-readwrite z-member z-c++">m_core</span><span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-variable z-other z-readwrite z-member z-c++">PIN_5</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">seg<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">setSegment</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">Segment<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>F<span class="z-punctuation z-separator z-c++">,</span> tb<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-variable z-other z-readwrite z-member z-c++">m_core</span><span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-variable z-other z-readwrite z-member z-c++">PIN_6</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">seg<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">setSegment</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">Segment<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>G<span class="z-punctuation z-separator z-c++">,</span> tb<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-variable z-other z-readwrite z-member z-c++">m_core</span><span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-variable z-other z-readwrite z-member z-c++">PIN_7</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">seg<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">setSegment</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">Segment<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>DP<span class="z-punctuation z-separator z-c++">,</span> tb<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-variable z-other z-readwrite z-member z-c++">m_core</span><span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-variable z-other z-readwrite z-member z-c++">PIN_8</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++">seg<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">draw</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-keyword z-operator z-c">*</span>renderWin<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">get</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<h2 id="running-the-simulation">Running the simulation</h2>
<p>You can build the simulation and synthesize the project using our CMake/Conan workflow that we developed last time:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> Assuming you&#39;re in the 02_seven_seg_parallel/ folder.</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mkdir</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> build</span> <span class="z-keyword z-operator z-logical z-and z-shell">&amp;&amp;</span> <span class="z-meta z-function-call z-shell"><span class="z-support z-function z-cd z-shell">cd</span></span><span class="z-meta z-function-call z-arguments z-shell"> build</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">conan</span></span><span class="z-meta z-function-call z-arguments z-shell"> install ..</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cmake</span></span><span class="z-meta z-function-call z-arguments z-shell"> ..</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cmake</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>build</span> .</span>
</span></code></pre>
<p>If you run the simulation (in WSL):</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-cd z-shell">cd</span></span><span class="z-meta z-function-call z-arguments z-shell"> bin</span>
</span><span class="z-source z-shell z-bash"><span class="z-variable z-other z-readwrite z-assignment z-shell">DISPLAY</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">:0</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">./seven_seg_parallel</span></span>
</span></code></pre>
<p>You should see the following window pop up with our segment display counting up in hexadecimal:</p>
 <img src="seven_seg_sim.png" alt="Parallel Seven Segment Display Simulation" width="800" height="629" loading="lazy" />
<h1 id="laying-it-out-on-a-breadboard">Laying it out on a breadboard</h1>
<p>So far we've been strictly in the realm of simulation or using the built in LED.  Now we're going to build our circuit out using a breadboard and wires to hook everything together.</p>
<p>To start with we'll look at the schematic view to see how things are hooked together.  This was drawn up in <a rel="noopener" target="_blank" href="https://www.kicad-pcb.org/">KiCad</a>:</p>
 <img src="seven_seg_parallel_schematic.png" alt="Parallel seven segment display schematic" width="1389" height="1131" loading="lazy" />
<p>We will power the TinyFPGA board itself through USB, and we can use the GND pins on the TinyFPGA board to complete the circuit for the LEDs.  The output pins need to go through current-limiting resistors when paired with the LEDS in the seven segment display, or else when we pull a pin high it will be short-circuit and we could burn up our chip.</p>
<p>A minor note, but in the schematic I'm using a pin compatible part with package KCSC02, which is not the same physical package as the components I'm using on my breadboard which are in package 5611AS.  The KCSC one, which I was able to find in the KiCad library, is a surface mount package versus the through-hole ones we'll use on the breadboard.</p>
<p>When we lay it out in real life, it will look something like the following.  Here I'm using the program Fritzing to diagram out how the breadboard looks and we'll break it down as the layouts get more complicated in the future.</p>
 <img src="seven_seg_parallel_bb.png" alt="Laying out the parallel seven segment display" width="1755" height="636" loading="lazy" />
<p>If we look at the <a rel="noopener" target="_blank" href="http://www.latticesemi.com/view_document?document_id=49312">Ice40 datasheet</a>, and look at the I/O DC electrical characteristics table in section 4.14 on page 25, we see that the max current for a normal pin is 8 milliamps for the 3.3V the board uses.  We're not configuring the pins as high current LED outputs in this case, so we'll use the lowest number in that table.</p>
<p>Given Ohm's Law, we can choose the value of the resistor so that we get a current of ~8ma.  R = V / I = 3.3V / 0.008 A = 412.5 Ohms, so a standard 430 or 470 Ohm resistor will be close enough for our purposes.  In my case, I went with 470 Ohm ones.</p>
<p>If we deploy the design to our circuit above, we'll see our implementation running in meat space</p>
<video controls class="ci">
  <source src="seven_seg_parallel.mp4" type="video/mp4" />
  Your browser doesn't support the video tag and/or the video formats in use here – sorry!
</video><h1 id="driving-a-seven-segment-display-with-fewer-pins">Driving a seven segment display with fewer pins</h1>
<p>Everything works fine so far, but we're rather limited because we are using 8 of our 40ish pins on our TinyFPGA-BX board to drive only a single seven segment display.  It would be nicer if we didn't need to use so many pins because they're a pretty restricted resource for us.</p>
<p>What we can do, since the segment displays will update at a much slower pace than our circuit design runs, is use a shift register to use only three pins of the FPGA to get the eight values needed out, and use the shift register chip to drive the actual seven segment display.</p>
<p>Just like with seven segment displays themselves, there are also many tutorials out there describing shift registers in detail, so I won't repeat all of details here.  The short story is that you can pipe in bits serially, one at a time, and then 'latch' (i.e. store and use) the last 8 values you sent in and have them show up as a parallel set of signals from the shift register.</p>
<p>One tutorial I found from a quick search is <a rel="noopener" target="_blank" href="https://lastminuteengineers.com/74hc595-shift-register-arduino-tutorial/">this one on lastminuteengineers.com</a> and looks pretty good.</p>
<h2 id="creating-a-shift-register-in-verilog">Creating a shift register in Verilog</h2>
<p>On the FPGA side, we'll be doing the opposite: taking a parallel signal, the byte for the seven segment display, and outputting a serial signal.  That is to say, at one clock we'll save off all of the bits of the input byte, and then over the course of a number of clock cycles after that, sent it out one bit at a time.</p>
<p>On the outside, on our breadboard, we'll hook that up to a 74HC595 serial in, parallel out shift register.  To output into a 74HC595, we just need to have the byte we want to send out coming into our module as input, and then have the 3 pins needed to shift it out.  That is, we'll have the output data value pin, a clock pin for the data signal, and a signal to indicate we're done shifting data and that the 74HC595 shift register on the breadboard should latch the current value onto its eight output pins.</p>
<p>In terms of implementation of our shift register module, we also need to have an input to trigger us to start shifting out the current byte.  We then move through a state machine that shifts out each bit of our byte and finally triggers the latch signal before moving back to a waiting state.</p>
<script async src="https://unpkg.com/mermaid@11.4.0/dist/mermaid.min.js"></script>

<div style="text-align: center">
    <div class="mermaid">
        stateDiagram
    [*] --&gt; WAIT_STATE
    WAIT_STATE --&gt; SHIFT_STATE
    SHIFT_STATE --&gt; SHIFT_TICK
    SHIFT_TICK --&gt; SHIFT_STATE
    SHIFT_TICK --&gt; STORE_STATE
    STORE_STATE --&gt; WAIT_STATE
    </div>
</div>
<p>The code for the shift register is in <code>/lib/shift_reg_output.v</code>:</p>
<pre data-lang="verilog" class="language-verilog z-code"><code class="language-verilog" data-lang="verilog"><span class="z-source z-systemverilog"><span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> This module shifts out data to a 74HC595 shift register given
</span></span><span class="z-source z-systemverilog"><span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> a maximum 16 MHz clock input (from Tiny FPGA BX).
</span></span><span class="z-source z-systemverilog"><span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span>
</span></span><span class="z-source z-systemverilog"><span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> Module based on information from:
</span></span><span class="z-source z-systemverilog"><span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span>   https://components101.com/ics/74hc595-shift-register-pinout-datasheet
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog"><span class="z-keyword z-control z-systemverilog">module</span> <span class="z-entity z-name z-type z-module z-systemverilog">shift_reg_output</span>
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    (
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">        i_clk
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">        , i_reset
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">        <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> The value we want to shift out serially.
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">        , i_value
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">        <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> toggle switch to stream out the data.
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">        , i_enable_toggle
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">        <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> serial data
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">        , o_data_val
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">        <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> clock of data signal
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">        , o_data_clock          
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">        <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> latch trigger to show output of shift register on output pins
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">        , o_latch_shifted_value 
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    );</span>
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog">    <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> A parameter that lets us parameterize the shift register over the 2^n bits 
</span></span><span class="z-source z-systemverilog">    <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> we want to shift out.  By default we use a single byte (2^3 bits)
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-param z-systemverilog">    <span class="z-keyword z-other z-systemverilog">parameter</span> <span class="z-constant z-other z-systemverilog">DATA_WIDTH</span> </span><span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-decimal z-systemverilog">3</span>;
</span><span class="z-source z-systemverilog"><span class="z-meta z-param z-systemverilog">    <span class="z-keyword z-other z-systemverilog">localparam</span> <span class="z-constant z-other z-systemverilog">DATA_SIZE</span> </span><span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-decimal z-systemverilog">1</span> <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;</span><span class="z-keyword z-operator z-comparison z-systemverilog">&lt;</span> <span class="z-constant z-other z-net z-systemverilog">DATA_WIDTH</span>;
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog"><span class="z-support z-type z-systemverilog">    input</span> [<span class="z-constant z-other z-net z-systemverilog">DATA_SIZE</span><span class="z-keyword z-operator z-arithmetic z-systemverilog">-</span><span class="z-constant z-numeric z-decimal z-systemverilog">1</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span><span class="z-constant z-numeric z-decimal z-systemverilog">0</span>] i_value;
</span><span class="z-source z-systemverilog"><span class="z-support z-type z-systemverilog">    input</span> i_clk;
</span><span class="z-source z-systemverilog"><span class="z-support z-type z-systemverilog">    input</span> i_reset;
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog">    <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> When a new value is to be streamed out, this value must be toggled to 
</span></span><span class="z-source z-systemverilog">    <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> let us know to do that.  The assumption is that we are streaming out
</span></span><span class="z-source z-systemverilog">    <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> the value much faster than the toggle.
</span></span><span class="z-source z-systemverilog"><span class="z-support z-type z-systemverilog">    input</span> i_enable_toggle;
</span><span class="z-source z-systemverilog"><span class="z-storage z-type z-systemverilog">    reg</span> last_enable_toggle;
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog">    <span class="z-support z-type z-systemverilog">output</span> <span class="z-storage z-type z-interface z-systemverilog">reg</span> o_data_val;
</span><span class="z-source z-systemverilog">    <span class="z-support z-type z-systemverilog">output</span> <span class="z-storage z-type z-interface z-systemverilog">reg</span> o_data_clock;
</span><span class="z-source z-systemverilog">    <span class="z-support z-type z-systemverilog">output</span> <span class="z-storage z-type z-interface z-systemverilog">reg</span> o_latch_shifted_value;
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog">    <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> Our state machine state constants.
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-param z-systemverilog">    <span class="z-keyword z-other z-systemverilog">localparam</span> <span class="z-constant z-other z-systemverilog">WAIT_STATE</span> </span><span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-decimal z-systemverilog">0</span>;
</span><span class="z-source z-systemverilog"><span class="z-meta z-param z-systemverilog">    <span class="z-keyword z-other z-systemverilog">localparam</span> <span class="z-constant z-other z-systemverilog">SHIFT_STATE</span> </span><span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-decimal z-systemverilog">1</span>;
</span><span class="z-source z-systemverilog"><span class="z-meta z-param z-systemverilog">    <span class="z-keyword z-other z-systemverilog">localparam</span> <span class="z-constant z-other z-systemverilog">SHIFT_TICK</span> </span><span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-decimal z-systemverilog">2</span>;
</span><span class="z-source z-systemverilog"><span class="z-meta z-param z-systemverilog">    <span class="z-keyword z-other z-systemverilog">localparam</span> <span class="z-constant z-other z-systemverilog">STORE_STATE</span> </span><span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-decimal z-systemverilog">3</span>;
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog">    <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> We have four states, so we can hold our state in two bits.
</span></span><span class="z-source z-systemverilog"><span class="z-storage z-type z-systemverilog">    reg</span>[<span class="z-constant z-numeric z-decimal z-systemverilog">1</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span><span class="z-constant z-numeric z-decimal z-systemverilog">0</span>] current_state <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-other z-net z-systemverilog">WAIT_STATE</span>;
</span><span class="z-source z-systemverilog">    
</span><span class="z-source z-systemverilog"><span class="z-storage z-type z-systemverilog">    reg</span> [<span class="z-constant z-other z-net z-systemverilog">DATA_SIZE</span><span class="z-keyword z-operator z-arithmetic z-systemverilog">-</span><span class="z-constant z-numeric z-decimal z-systemverilog">1</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span><span class="z-constant z-numeric z-decimal z-systemverilog">0</span>] shift_value;
</span><span class="z-source z-systemverilog"><span class="z-storage z-type z-systemverilog">    reg</span> [<span class="z-constant z-other z-net z-systemverilog">DATA_WIDTH</span><span class="z-keyword z-operator z-arithmetic z-systemverilog">+</span><span class="z-constant z-numeric z-decimal z-systemverilog">1</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span><span class="z-constant z-numeric z-decimal z-systemverilog">0</span>] shift_cnt;
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog">    <span class="z-keyword z-control z-systemverilog">always</span> <span class="z-keyword z-operator z-other z-systemverilog">@</span>(<span class="z-keyword z-control z-systemverilog">posedge</span> i_clk) 
</span><span class="z-source z-systemverilog">    <span class="z-keyword z-control z-systemverilog">begin</span>
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog">      <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> On reset simply go back to our waiting state.
</span></span><span class="z-source z-systemverilog">      <span class="z-keyword z-control z-systemverilog">if</span>(i_reset) <span class="z-keyword z-control z-systemverilog">begin</span>
</span><span class="z-source z-systemverilog">        current_state <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> <span class="z-constant z-other z-net z-systemverilog">WAIT_STATE</span>;
</span><span class="z-source z-systemverilog">      <span class="z-keyword z-other z-block z-systemverilog">end</span>
</span><span class="z-source z-systemverilog">      <span class="z-keyword z-control z-systemverilog">else</span> <span class="z-keyword z-control z-systemverilog">begin</span>
</span><span class="z-source z-systemverilog">        <span class="z-keyword z-control z-systemverilog">case</span>(current_state)
</span><span class="z-source z-systemverilog">            <span class="z-constant z-other z-net z-systemverilog">WAIT_STATE</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span> 
</span><span class="z-source z-systemverilog">            <span class="z-keyword z-control z-systemverilog">begin</span>
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog">              <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> Check for starting a new shift out process.
</span></span><span class="z-source z-systemverilog">              <span class="z-keyword z-control z-systemverilog">if</span>(i_enable_toggle <span class="z-keyword z-operator z-comparison z-systemverilog">!=</span> last_enable_toggle) <span class="z-keyword z-control z-systemverilog">begin</span>
</span><span class="z-source z-systemverilog">                last_enable_toggle <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> i_enable_toggle;
</span><span class="z-source z-systemverilog">                current_state <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> <span class="z-constant z-other z-net z-systemverilog">SHIFT_STATE</span>; 
</span><span class="z-source z-systemverilog">                shift_value <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> i_value;
</span><span class="z-source z-systemverilog">                shift_cnt <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> <span class="z-constant z-numeric z-decimal z-systemverilog">0</span>;
</span><span class="z-source z-systemverilog">                o_data_val <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> i_value[<span class="z-constant z-other z-net z-systemverilog">DATA_SIZE</span><span class="z-keyword z-operator z-arithmetic z-systemverilog">-</span><span class="z-constant z-numeric z-decimal z-systemverilog">1</span>];
</span><span class="z-source z-systemverilog">              <span class="z-keyword z-other z-block z-systemverilog">end</span>
</span><span class="z-source z-systemverilog">              <span class="z-keyword z-control z-systemverilog">else</span> <span class="z-keyword z-control z-systemverilog">begin</span>
</span><span class="z-source z-systemverilog">                o_data_val <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> <span class="z-constant z-numeric z-decimal z-systemverilog">0</span>;
</span><span class="z-source z-systemverilog">              <span class="z-keyword z-other z-block z-systemverilog">end</span>
</span><span class="z-source z-systemverilog">              
</span><span class="z-source z-systemverilog">              o_data_clock <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> <span class="z-constant z-numeric z-decimal z-systemverilog">0</span>;
</span><span class="z-source z-systemverilog">              o_latch_shifted_value <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> <span class="z-constant z-numeric z-decimal z-systemverilog">0</span>;
</span><span class="z-source z-systemverilog">            <span class="z-keyword z-other z-block z-systemverilog">end</span>
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog">            <span class="z-constant z-other z-net z-systemverilog">SHIFT_STATE</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span>
</span><span class="z-source z-systemverilog">            <span class="z-keyword z-control z-systemverilog">begin</span>
</span><span class="z-source z-systemverilog">                <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> clock goes high, meaning the value of data should be 
</span></span><span class="z-source z-systemverilog">                <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> sampled on the receiving end.
</span></span><span class="z-source z-systemverilog">                o_data_clock <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> <span class="z-constant z-numeric z-decimal z-systemverilog">1</span>; 
</span><span class="z-source z-systemverilog">                o_latch_shifted_value <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> <span class="z-constant z-numeric z-decimal z-systemverilog">0</span>;
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog">                <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> Since we latch the MSB in this clock tick, we also want
</span></span><span class="z-source z-systemverilog">                <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> to shift our value over by one for the next time we want
</span></span><span class="z-source z-systemverilog">                <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> to load a bit for output.
</span></span><span class="z-source z-systemverilog">                shift_value <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> shift_value <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;</span><span class="z-keyword z-operator z-comparison z-systemverilog">&lt;</span> <span class="z-constant z-numeric z-decimal z-systemverilog">1</span>;
</span><span class="z-source z-systemverilog">                shift_cnt <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> shift_cnt <span class="z-keyword z-operator z-arithmetic z-systemverilog">+</span> <span class="z-constant z-numeric z-decimal z-systemverilog">1</span>;
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog">                current_state <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> <span class="z-constant z-other z-net z-systemverilog">SHIFT_TICK</span>;
</span><span class="z-source z-systemverilog">            <span class="z-keyword z-other z-block z-systemverilog">end</span>
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog">            <span class="z-constant z-other z-net z-systemverilog">SHIFT_TICK</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span>
</span><span class="z-source z-systemverilog">            <span class="z-keyword z-control z-systemverilog">begin</span>
</span><span class="z-source z-systemverilog">                <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> Set the output value to the upcoming bit value for the next
</span></span><span class="z-source z-systemverilog">                <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> tick.
</span></span><span class="z-source z-systemverilog">                o_data_val <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> shift_value[<span class="z-constant z-other z-net z-systemverilog">DATA_SIZE</span><span class="z-keyword z-operator z-arithmetic z-systemverilog">-</span><span class="z-constant z-numeric z-decimal z-systemverilog">1</span>];
</span><span class="z-source z-systemverilog">                
</span><span class="z-source z-systemverilog">                o_data_clock <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> <span class="z-constant z-numeric z-decimal z-systemverilog">0</span>;
</span><span class="z-source z-systemverilog">                o_latch_shifted_value <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> <span class="z-constant z-numeric z-decimal z-systemverilog">0</span>;
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog">                <span class="z-keyword z-control z-systemverilog">if</span>(shift_cnt <span class="z-keyword z-operator z-comparison z-systemverilog">==</span> <span class="z-constant z-other z-net z-systemverilog">DATA_SIZE</span>) <span class="z-keyword z-control z-systemverilog">begin</span>
</span><span class="z-source z-systemverilog">                  <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> Our count reached the end of our number of bits to shift 
</span></span><span class="z-source z-systemverilog">                  <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> out.
</span></span><span class="z-source z-systemverilog">                  current_state <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> <span class="z-constant z-other z-net z-systemverilog">STORE_STATE</span>;
</span><span class="z-source z-systemverilog">                <span class="z-keyword z-other z-block z-systemverilog">end</span>
</span><span class="z-source z-systemverilog">                <span class="z-keyword z-control z-systemverilog">else</span> <span class="z-keyword z-control z-systemverilog">begin</span>
</span><span class="z-source z-systemverilog">                  <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> We&#39;re not done, so back to the shift state
</span></span><span class="z-source z-systemverilog">                  current_state <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> <span class="z-constant z-other z-net z-systemverilog">SHIFT_STATE</span>;
</span><span class="z-source z-systemverilog">                <span class="z-keyword z-other z-block z-systemverilog">end</span>
</span><span class="z-source z-systemverilog">            <span class="z-keyword z-other z-block z-systemverilog">end</span>
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog">            <span class="z-constant z-other z-net z-systemverilog">STORE_STATE</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span>
</span><span class="z-source z-systemverilog">            <span class="z-keyword z-control z-systemverilog">begin</span>
</span><span class="z-source z-systemverilog">                <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> Raise the latch signal high so that the receiving shift reg
</span></span><span class="z-source z-systemverilog">                <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> will store the current data and present it on its outputs.
</span></span><span class="z-source z-systemverilog">                o_data_clock <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> <span class="z-constant z-numeric z-decimal z-systemverilog">0</span>;
</span><span class="z-source z-systemverilog">                o_latch_shifted_value <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> <span class="z-constant z-numeric z-decimal z-systemverilog">1</span>;
</span><span class="z-source z-systemverilog">                current_state <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> <span class="z-constant z-other z-net z-systemverilog">WAIT_STATE</span>;
</span><span class="z-source z-systemverilog">            <span class="z-keyword z-other z-block z-systemverilog">end</span>
</span><span class="z-source z-systemverilog">        <span class="z-keyword z-control z-systemverilog">endcase</span>
</span><span class="z-source z-systemverilog">       <span class="z-keyword z-other z-block z-systemverilog">end</span>
</span><span class="z-source z-systemverilog">    <span class="z-keyword z-other z-block z-systemverilog">end</span>
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog"><span class="z-meta z-object z-end z-systemverilog"><span class="z-keyword z-control z-systemverilog">endmodule</span></span>
</span></code></pre>
<p>Now in our new <code>top</code> module in <code>03_seven_seg_shift_reg/top.v</code>, we don't need to use 8 output pins
since we'll shift out our display value one bit at a time.  Instead our port map will now look like this:</p>
<pre data-lang="verilog" class="language-verilog z-code"><code class="language-verilog" data-lang="verilog"><span class="z-source z-systemverilog"><span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> look in pins.pcf for all the pin names on the TinyFPGA BX board
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog"><span class="z-keyword z-control z-systemverilog">module</span> <span class="z-entity z-name z-type z-module z-systemverilog">top</span> (
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog"><span class="z-support z-type z-systemverilog">    input</span> <span class="z-constant z-other z-net z-systemverilog">CLK</span>       <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> 16MHz clock
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    ,<span class="z-support z-type z-systemverilog"> output</span> <span class="z-constant z-other z-net z-systemverilog">LED</span>    <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> User/boot LED next to power LED
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    ,<span class="z-support z-type z-systemverilog"> output</span> <span class="z-constant z-other z-net z-systemverilog">USBPU</span>  <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> USB pull-up resistor
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    ,<span class="z-support z-type z-systemverilog"> output</span> <span class="z-constant z-other z-net z-systemverilog">PIN_1</span>  <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> shift register data signal
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    ,<span class="z-support z-type z-systemverilog"> output</span> <span class="z-constant z-other z-net z-systemverilog">PIN_2</span>  <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> shift register data clock
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    ,<span class="z-support z-type z-systemverilog"> output</span> <span class="z-constant z-other z-net z-systemverilog">PIN_3</span>  <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> shift register latch to outputs.
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog"><span class="z-constant z-other z-preprocessor z-systemverilog">`ifdef</span> <span class="z-support z-variable z-systemverilog">SIMULATION</span>
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    ,<span class="z-support z-type z-systemverilog"> output</span> [<span class="z-constant z-numeric z-decimal z-systemverilog">3</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span><span class="z-constant z-numeric z-decimal z-systemverilog">0</span>] o_num
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">    ,<span class="z-support z-type z-systemverilog"> output</span> [<span class="z-constant z-numeric z-decimal z-systemverilog">7</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span><span class="z-constant z-numeric z-decimal z-systemverilog">0</span>] o_seg_out <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> Debug output for simulator to veify shifted data is correct.
</span></span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog"><span class="z-constant z-other z-preprocessor z-systemverilog">`endif</span>
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-systemverilog">);</span>
</span></code></pre>
<p>Our decoder will be the same as before, outputting a byte that we want to display on the seven segment display using the counter bits as input.  We'll now instead connect the output wires of the decoder <code>seg_out</code> to our shift register and toggle the shift out based on the LSB (Least Significant Bit) of our counter value so that whenever it changes, we'll shift out our new value.</p>
<pre data-lang="verilog" class="language-verilog z-code"><code class="language-verilog" data-lang="verilog"><span class="z-source z-systemverilog"><span class="z-storage z-type z-systemverilog">    reg</span> shift_reg_clock <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-decimal z-systemverilog">0</span>; 
</span><span class="z-source z-systemverilog"><span class="z-storage z-type z-systemverilog">    reg</span> shift_toggle <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> <span class="z-constant z-numeric z-decimal z-systemverilog">0</span>;
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog">    <span class="z-meta z-module z-inst z-systemverilog"><span class="z-storage z-type z-module z-systemverilog">shift_reg_output</span> <span class="z-entity z-name z-type z-module z-systemverilog">shiftReg</span>(
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-inst z-systemverilog">            .<span class="z-support z-function z-port z-systemverilog">i_clk</span>(shift_reg_clock),
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-inst z-systemverilog">            .<span class="z-support z-function z-port z-systemverilog">i_reset</span>(<span class="z-constant z-numeric z-systemverilog">1&#39;b0</span>),
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-inst z-systemverilog">            .<span class="z-support z-function z-port z-systemverilog">i_value</span>(<span class="z-keyword z-operator z-other z-systemverilog">{</span>shift_toggle, seg_out[<span class="z-constant z-numeric z-decimal z-systemverilog">6</span><span class="z-keyword z-operator z-ternary z-systemverilog">:</span><span class="z-constant z-numeric z-decimal z-systemverilog">0</span>]<span class="z-keyword z-operator z-other z-systemverilog">}</span>),
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-inst z-systemverilog">            .<span class="z-support z-function z-port z-systemverilog">i_enable_toggle</span>(shift_toggle),
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-inst z-systemverilog">
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-inst z-systemverilog">            .<span class="z-support z-function z-port z-systemverilog">o_data_val</span>(sh_ds),
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-inst z-systemverilog">            .<span class="z-support z-function z-port z-systemverilog">o_data_clock</span>(sh_clk),
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-inst z-systemverilog">            .<span class="z-support z-function z-port z-systemverilog">o_latch_shifted_value</span>(sh_latch)
</span></span><span class="z-source z-systemverilog"><span class="z-meta z-module z-inst z-systemverilog">        );</span>
</span><span class="z-source z-systemverilog">
</span><span class="z-source z-systemverilog">    <span class="z-comment z-line z-double-slash z-systemverilog"><span class="z-punctuation z-definition z-comment z-systemverilog">//</span> increment the blink_counter every clock
</span></span><span class="z-source z-systemverilog">    <span class="z-keyword z-control z-systemverilog">always</span> <span class="z-keyword z-operator z-other z-systemverilog">@</span>(<span class="z-keyword z-control z-systemverilog">posedge</span> <span class="z-constant z-other z-net z-systemverilog">CLK</span>) <span class="z-keyword z-control z-systemverilog">begin</span>
</span><span class="z-source z-systemverilog">        counter <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> counter <span class="z-keyword z-operator z-arithmetic z-systemverilog">+</span> <span class="z-constant z-numeric z-decimal z-systemverilog">1</span>;
</span><span class="z-source z-systemverilog">        shift_reg_clock <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> counter[<span class="z-constant z-other z-net z-systemverilog">CLOCK_BIT</span>];
</span><span class="z-source z-systemverilog">        shift_toggle <span class="z-keyword z-operator z-comparison z-systemverilog">&lt;=</span> counter[<span class="z-constant z-other z-net z-systemverilog">LOW_BIT</span>];
</span><span class="z-source z-systemverilog">    <span class="z-keyword z-other z-block z-systemverilog">end</span>
</span></code></pre>
<p>and at the bottom of the <code>top</code> module, we assign our wires from the output of the shift register instance to our output pins:</p>
<pre data-lang="verilog" class="language-verilog z-code"><code class="language-verilog" data-lang="verilog"><span class="z-source z-systemverilog"><span class="z-keyword z-control z-systemverilog">assign</span> <span class="z-constant z-other z-net z-systemverilog">PIN_1</span> <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> sh_ds;
</span><span class="z-source z-systemverilog"><span class="z-keyword z-control z-systemverilog">assign</span> <span class="z-constant z-other z-net z-systemverilog">PIN_2</span> <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> sh_clk;
</span><span class="z-source z-systemverilog"><span class="z-keyword z-control z-systemverilog">assign</span> <span class="z-constant z-other z-net z-systemverilog">PIN_3</span> <span class="z-keyword z-operator z-assignment z-systemverilog">=</span> sh_latch;
</span></code></pre>
<h2 id="creating-a-mock-shift-register-reader">Creating a mock shift register reader</h2>
<p>On the simulation side, we'll want to be able to read the shift register values as they are pushed out and latch the value to our seven segment display once the latch signal is raised.  So we do the opposite and read in a serial stream of bits and present the current latched value as the output.</p>
<p>We will soon want to be able to have more than just 8 bits on our output in order to represent having multiple shift registers chained together, so the simulation SIPO (serial in parallel out) shift register in <code>/lib/SerInParOutShiftRegister.h</code> is a template class that lets us choose the number of shift registers we want and uses a <code>std::bitset</code> underneath for storage:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-meta z-template z-c++"><span class="z-storage z-type z-template z-c++">template</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span></span><span class="z-meta z-template z-c++">std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-support z-type z-sys-types z-c">size_t</span> NumRegs</span><span class="z-meta z-template z-c++"><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span></span>
</span><span class="z-source z-c++"><span class="z-meta z-class z-c++"><span class="z-storage z-type z-c++">class</span> </span><span class="z-meta z-class z-c++"><span class="z-entity z-name z-class z-c++">SerInParOutShiftReg</span></span><span class="z-meta z-class z-c++">
</span></span><span class="z-source z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++"><span class="z-storage z-modifier z-c++">private</span><span class="z-punctuation z-section z-class z-c++">:</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-modifier z-c++">constexpr</span> <span class="z-storage z-modifier z-c++">static</span> <span class="z-storage z-modifier z-c++">const</span> std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-support z-type z-sys-types z-c">size_t</span> NumBits <span class="z-keyword z-operator z-assignment z-c">=</span> NumRegs<span class="z-keyword z-operator z-c">*</span><span class="z-constant z-numeric z-integer z-decimal z-c++">8</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-c++">using</span> <span class="z-entity z-name z-type z-using z-c++">ShiftReg</span> <span class="z-keyword z-operator z-assignment z-c">=</span> std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>bitset<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span>NumBits<span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    ShiftReg <span class="z-variable z-other z-readwrite z-member z-c++">mShiftData</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-variable z-other z-readwrite z-member z-c++">mLatched</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">bool</span> <span class="z-variable z-other z-readwrite z-member z-c++">mPrevDataClock</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-variable z-other z-readwrite z-member z-c++">mPrevLatch</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++"><span class="z-storage z-modifier z-c++">public</span><span class="z-punctuation z-section z-class z-c++">:</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-method z-constructor z-c++"><span class="z-entity z-name z-function z-constructor z-c++">SerInParOutShiftReg</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">void</span> <span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">update</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-storage z-type z-c">bool</span> <span class="z-variable z-parameter z-c++">dataIn</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-storage z-type z-c">bool</span> <span class="z-variable z-parameter z-c++">dataClock</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-storage z-type z-c">bool</span> <span class="z-variable z-parameter z-c++">latch</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">bool</span> <span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">getBitValue</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++">std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-support z-type z-sys-types z-c">size_t</span> <span class="z-variable z-parameter z-c++">which</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"> <span class="z-storage z-modifier z-c++">const</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">unsigned</span> <span class="z-storage z-type z-c">char</span> <span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">getSubByte</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++">std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-support z-type z-sys-types z-c">size_t</span> <span class="z-variable z-parameter z-c++">startByte</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"> <span class="z-storage z-modifier z-c++">const</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    ShiftReg <span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">getLatchedValue</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"> <span class="z-storage z-modifier z-c++">const</span> </span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"> <span class="z-keyword z-control z-flow z-return z-c++">return</span> <span class="z-variable z-other z-readwrite z-member z-c++">mLatched</span><span class="z-punctuation z-terminator z-c++">;</span> </span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++"></span></span><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>If you build and run the <code>03_seven_seg_shift_reg</code> example simulation, you'll see a single seven segment display counting up just like in our previous case, but now we're only using three pins for our display!</p>
<h2 id="building-the-circuit">Building the circuit</h2>
<p>We now need to add the 74HC595 chip to our circuit and wire things up, now just using pins 1, 2, 3 from the FPGA.  The following schematic shows how it sits between the FPGA <code>PIN</code>s and the set of resistors feeding to the seven segment display.</p>
 <img src="seven_seg_shift_schematic.png" alt="Shift Register Seven Segment Display Schematic" width="1312" height="757" loading="lazy" />
<p>Notice that we have two extra pins to concern ourselves with here: the output enable and the shift register's reset pin.  The reset pin should be tied high, i.e. a wire connecting it to Vcc, and the output enable should be tied low, i.e. a wire connecting it directly to ground.  This way our circuit will be able to output values and will not be constantly held in reset.</p>
<p>To lay this out on a breadboard, we'll want to lay it out something like this:</p>
 <img src="shift_reg_bb.png" alt="Shift Register Seven Segment Display Breadboard Circuit" width="1755" height="636" loading="lazy" />
<video controls class="ci">
  <source src="seven_seg_shift_reg.mp4" type="video/mp4" />
  Your browser doesn't support the video tag and/or the video formats in use here – sorry!
</video><h2 id="issues-i-ran-into">Issues I ran into</h2>
<p>I think it's helpful to see where things go wrong, so I thought I'd share some of the issues I ran into when going from the sunny day simulation environment to trying to make the design run on the bread board.</p>
<h3 id="timing-constraints">Timing Constraints</h3>
<p>Initially I designed everything and was happy with the simulation, but when I hooked up the circuit as shown, it wasn't working.  The LED segments weren't doing anything at all.</p>
<p>I first checked that all the connections looked good, made sure if I manually connected the wires to Vcc instead of the shift register that they'd light up, and everything looked good.  It occurred to me that maybe I was running things too fast, as I initially had simply hooked the shift register's clock input to the main 16Mhz clock.</p>
<p>Looking through the <a rel="noopener" target="_blank" href="https://components101.com/sites/default/files/component_datasheet/74HC595%20IC%20Datasheet_0.pdf">datasheet</a>, under 7.6 Timing Requirements, you see that at 2V you can run at a max of 5Mhz and at 4.5V you can run at 25 Mhz.  We're powering the shift register off of the TinyFPGA-BX at 3.3V so it'll be somewhere in between and sure enough, once I lowered the clock by creating a register that toggled based on higher bit of the counter, the LEDs started lighting up.</p>
<h3 id="using-the-counter-value-directly-for-the-divided-clock">Using the Counter Value Directly for the Divided Clock</h3>
<p>I had tried just passing in the <code>counter[CLOCK_BIT]</code> into the shift register's clock input, but I got a warning from Verilator about the signal being unoptimizable.  Some quick searching said it looks like it creates a feedback loop, so I changed to have a <code>reg</code> that I update in the clock process, buffering the signal, and that got rid of the warning.</p>
<h3 id="serialization-endianness">Serialization Endianness</h3>
<p>Once the segments were lighting up, I noticed the patterns were wrong.  The patterns were consistent in how they appeared, but not what I expected.  It turns out that the shift register expects the bits to come into the MSB first down to the LSB.  I was initially sending them in LSB to MSB, causing me to have a reversed pattern on the output from what I was expecting.</p>
<p>Changing which bit was shifted out in the <code>shift_reg_output</code> module and making the corresponding changes on the simulated shift register side and everything showed up correctly.</p>
<h1 id="conclusion">Conclusion</h1>
<p>We covered quite a bit this time and now are building circuits out with real components on breadboards, which I find to be really satisfying to hook up and see working in real life.</p>
<p>Next time we'll go into how we can drive multiple seven segment displays, still using the same three output pins of the FPGA.</p>
<div id="commento"></div>
<script src="https://cdn.commento.io/js/commento.js"></script>

      <nav>
        <div>
          <a href="https://www.walknsqualk.com/017-kubuntu/">&#8249; Switching to Kubuntu 20.10 as primary OS</a>
        </div>
        <div>
          <a href="https://www.walknsqualk.com/015-fpga-start2/"> FPGA Design for Software Engineers, Part 2 - Simulation and Build Tools &#8250;</a>
        </div>
      </nav>
    </article>
  </main>
  <footer>
    <hr />
    <div class="c">
      <nav class="tpad"><div><a type="application/atom+xml" href="https://www.walknsqualk.com/atom.xml" target="_blank" title="Walk N&#x27; Squawk Atom Feed"><i type="Button" class="svg rss" title="Walk N&#x27; Squawk Atom Feed"></i></a><a class="js m-protected" href="#c3JqaWxhcmlvdXNAZmFzdG1haWwubmV0" target="_blank" title="Mail"><i type="Button" class="svg mail" title="Mail"></i></a><a href="https://mastodon.social/@srjilarious" target="_blank" title="Mastodon" rel="me"><i type="Button" class="svg mastodon" title="Mastodon"></i></a><a href="https://gitlab.com/sr.jilarious/" target="_blank" title="Gitlab"><i type="Button" class="svg gitlab" title="Gitlab"></i></a><a href="https://github.com/srjilarious/" target="_blank" title="Github"><i type="Button" class="svg github" title="Github"></i></a></div></nav>
      <nav class="vpad">
        <a class="rpad s90" href="https://www.walknsqualk.com/about/"> About </a>
        <a class="rpad s90" href="https://www.walknsqualk.com/contact/"> Contact </a>
        <a class="rpad s90" href="https://www.walknsqualk.com/privacy/"> Privacy </a>
        <a class="rpad s90" href="https://www.walknsqualk.com/sitemap.xml" target="_blank"> Sitemap </a>
      </nav>
      <p class="s80"> &copy; <span id="year">2024</span> Walk N' Squawk</p>
      <p class="s80">Powered by <a href="https://www.getzola.org/" target="_blank">Zola</a> & <a href="https://github.com/jieiku/abridge/" target="_blank">Abridge</a></p>
    </div>
  </footer><span class="topout">
<span class="topleft"> </span><a href="#" class="top" title="Back to Top"><i class="svgs svgh angu"></i></a>
</span>
</body>
</html>
